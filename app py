import streamlit as st
import pandas as pd
from streamlit_stripe import stripe_button
from supabase import create_client, Client
import os

st.set_page_config(page_title="MenuOpt IA", layout="wide")

st.title("ðŸ“Š MenuOpt IA: Otimizador de Lucros para Delivery")

# --- 1. CONFIGURAÃ‡ÃƒO SUPABASE ---
# Pega as chaves das variÃ¡veis secretas configuradas no Streamlit Cloud
SUPABASE_URL = os.environ.get("SUPABASE_URL")
SUPABASE_KEY = os.environ.get("SUPABASE_KEY")

if SUPABASE_URL and SUPABASE_KEY:
    supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
else:
    st.error("Chaves do Supabase nÃ£o configuradas nas variÃ¡veis secretas do Streamlit.")

# --- 2. CONFIGURAÃ‡ÃƒO STRIPE ---
CHAVE_PUBLICA = "import streamlit as st
import pandas as pd
from streamlit_stripe import stripe_button
from supabase import create_client, Client
import os

st.set_page_config(page_title="MenuOpt IA", layout="wide")

st.title("ðŸ“Š MenuOpt IA: Otimizador de Lucros para Delivery")

# --- 1. CONFIGURAÃ‡ÃƒO SUPABASE ---
# Pega as chaves das variÃ¡veis secretas configuradas no Streamlit Cloud
SUPABASE_URL = os.environ.get("SUPABASE_URL")
SUPABASE_KEY = os.environ.get("SUPABASE_KEY")

if SUPABASE_URL and SUPABASE_KEY:
    supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)
else:
    st.error("Chaves do Supabase nÃ£o configuradas nas variÃ¡veis secretas do Streamlit.")

# --- 2. CONFIGURAÃ‡ÃƒO STRIPE ---
CHAVE_PUBLICA = "price_1Ss8boDnrs6odh41hnUr74lD 
PRICE_ID_PRO =price_1Ss8boDnrs6odh41hnUr74lD"

# --- 3. FUNCIONALIDADES DO APP ---

# FunÃ§Ã£o para salvar novo restaurante no DB
def registrar_restaurante(nome, email):
    try:
        data, count = supabase.table('restaurantes').insert({"nome_restaurante": nome, "email": email}).execute()
        st.success(f"Restaurante {nome} registrado com sucesso no banco de dados!")
        return data
    except Exception as e:
        st.error(f"Erro ao registrar: {e}")
        return None

# FormulÃ¡rio de Cadastro/Login Simples
with st.expander("ðŸ”‘ Acesso do Restaurante"):
    nome = st.text_input("Nome do Restaurante (para registro)")
    email = st.text_input("E-mail de contato")
    if st.button("Registrar"):
        if nome and email:
            registrar_restaurante(nome, email)

st.markdown("---")

# Ãrea de Assinatura Premium (VisÃ­vel para todos, mas checkout sÃ³ funciona com chaves reais)
st.header("Torne-se Premium para anÃ¡lise ilimitada!")
checkout = stripe_button(
    price_id=PRICE_ID_PRO,
    client_reference_id=email, # Passa o email do usuÃ¡rio para o Stripe
    stripe_key=CHAVE_PUBLICA,
    label="Assinar MenuOpt Pro (R$ 49/mÃªs)",
)

if checkout:
    st.success("ðŸŽ‰ Pagamento realizado com sucesso! Verifique seu e-mail para os prÃ³ximos passos.")
    # No futuro, vocÃª usarÃ¡ os Webhooks do Stripe para uma confirmaÃ§Ã£o automÃ¡tica

st.markdown("---")

# ... (O resto do seu aplicativo antigo continua aqui embaixo, a lÃ³gica de cÃ¡lculo) ...
col1, col2 = st.columns(2)

with col1:
    st.header("ðŸ›’ Adicionar Item")
    item = st.text_input("Nome do Prato (Ex: X-Salada)")
    custo = st.number_input("Custo de ProduÃ§Ã£o (R$)", min_value=0.0)
    venda = st.number_input("PreÃ§o de Venda Atual (R$)", min_value=0.0)
    btn_analisar = st.button("Analisar Lucratividade")

with col2:
    st.header("ðŸ’¡ SugestÃ£o da IA")
    if btn_analisar:
        lucro_bruto = venda - custo
        margem = (lucro_bruto / venda) * 100 if venda > 0 else 0
        
        st.metric("Margem Atual", f"{margem:.1f}%")
        
        if margem < 30:
            st.warning("âš ï¸ AtenÃ§Ã£o: Sua margem estÃ¡ abaixo do mercado (30%).")
            sugestao = custo / (1 - 0.35)
            st.success(f"ðŸ“ˆ SugestÃ£o: Reajuste para R$ {sugestao:.2f} para ter 35% de margem.")
        else:
            st.info("âœ… Sua margem estÃ¡ saudÃ¡vel. Foque em combos para aumentar o ticket mÃ©dio!")
" 
PRICE_ID_PRO = "SEU_PRICE_ID_STRIPE"

# --- 3. FUNCIONALIDADES DO APP ---

# FunÃ§Ã£o para salvar novo restaurante no DB
def registrar_restaurante(nome, email):
    try:
        data, count = supabase.table('restaurantes').insert({"nome_restaurante": nome, "email": email}).execute()
        st.success(f"Restaurante {nome} registrado com sucesso no banco de dados!")
        return data
    except Exception as e:
        st.error(f"Erro ao registrar: {e}")
        return None

# FormulÃ¡rio de Cadastro/Login Simples
with st.expander("ðŸ”‘ Acesso do Restaurante"):
    nome = st.text_input("Nome do Restaurante (para registro)")
    email = st.text_input("E-mail de contato")
    if st.button("Registrar"):
        if nome and email:
            registrar_restaurante(nome, email)

st.markdown("---")

# Ãrea de Assinatura Premium (VisÃ­vel para todos, mas checkout sÃ³ funciona com chaves reais)
st.header("Torne-se Premium para anÃ¡lise ilimitada!")
checkout = stripe_button(
    price_id=PRICE_ID_PRO,
    client_reference_id=email, # Passa o email do usuÃ¡rio para o Stripe
    stripe_key=CHAVE_PUBLICA,
    label="Assinar MenuOpt Pro (R$ 49/mÃªs)",
)

if checkout:
    st.success("ðŸŽ‰ Pagamento realizado com sucesso! Verifique seu e-mail para os prÃ³ximos passos.")
    # No futuro, vocÃª usarÃ¡ os Webhooks do Stripe para uma confirmaÃ§Ã£o automÃ¡tica

st.markdown("---")

# ... (O resto do seu aplicativo antigo continua aqui embaixo, a lÃ³gica de cÃ¡lculo) ...
col1, col2 = st.columns(2)

with col1:
    st.header("ðŸ›’ Adicionar Item")
    item = st.text_input("Nome do Prato (Ex: X-Salada)")
    custo = st.number_input("Custo de ProduÃ§Ã£o (R$)", min_value=0.0)
    venda = st.number_input("PreÃ§o de Venda Atual (R$)", min_value=0.0)
    btn_analisar = st.button("Analisar Lucratividade")

with col2:
    st.header("ðŸ’¡ SugestÃ£o da IA")
    if btn_analisar:
        lucro_bruto = venda - custo
        margem = (lucro_bruto / venda) * 100 if venda > 0 else 0
        
        st.metric("Margem Atual", f"{margem:.1f}%")
        
        if margem < 30:
            st.warning("âš ï¸ AtenÃ§Ã£o: Sua margem estÃ¡ abaixo do mercado (30%).")
            sugestao = custo / (1 - 0.35)
            st.success(f"ðŸ“ˆ SugestÃ£o: Reajuste para R$ {sugestao:.2f} para ter 35% de margem.")
        else:
            st.info("âœ… Sua margem estÃ¡ saudÃ¡vel. Foque em combos para aumentar o ticket mÃ©dio!")
